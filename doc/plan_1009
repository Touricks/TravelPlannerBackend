 Planning Module Refactoring Plan                                                                                                                                                   â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Phase 1: Critical Security Fixes âš ï¸                                                                                                                                                â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ 1. Add @AuthenticationPrincipal UserEntity user to PlanningController                                                                                                              â”‚ â”‚
â”‚ â”‚ 2. Implement ownership verification (isItineraryOwnedByUser())                                                                                                                     â”‚ â”‚
â”‚ â”‚ 3. Update AppConfig to require authentication for planning endpoints                                                                                                               â”‚ â”‚
â”‚ â”‚ 4. Return 403 Forbidden for unauthorized access                                                                                                                                    â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Phase 2: Standardize AI Integration ğŸ¤–                                                                                                                                             â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Option A (Recommended): Migrate to LangChain4j                                                                                                                                     â”‚ â”‚
â”‚ â”‚ 1. Create PlanningAiService with @AiService annotation                                                                                                                             â”‚ â”‚
â”‚ â”‚ 2. Define Mustache templates for prompts                                                                                                                                           â”‚ â”‚
â”‚ â”‚ 3. Remove McpAiClient and McpAiClientImpl                                                                                                                                          â”‚ â”‚
â”‚ â”‚ 4. Add retry logic (3 attempts with exponential backoff)                                                                                                                           â”‚ â”‚
â”‚ â”‚ 5. Reuse existing LangChain4j configuration                                                                                                                                        â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Option B: Keep RestTemplate + standardize                                                                                                                                          â”‚ â”‚
â”‚ â”‚ 1. Add timeout configuration                                                                                                                                                       â”‚ â”‚
â”‚ â”‚ 2. Add retry mechanism                                                                                                                                                             â”‚ â”‚
â”‚ â”‚ 3. Add circuit breaker                                                                                                                                                             â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Phase 3: Error Handling Standardization ğŸ›¡                                                                                                                                         â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ 1. Create GlobalExceptionHandler with @ControllerAdvice                                                                                                                            â”‚ â”‚
â”‚ â”‚ 2. Handle all exceptions with proper HTTP status codes (404, 400, 403, 503, 500)                                                                                                   â”‚ â”‚
â”‚ â”‚ 3. Return consistent ErrorResponse structure                                                                                                                                       â”‚ â”‚
â”‚ â”‚ 4. Add comprehensive logging                                                                                                                                                       â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Phase 4: Complete Response Data ğŸ“Š                                                                                                                                                 â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ 1. Inject PlaceMapper from Recommendation module                                                                                                                                   â”‚ â”‚
â”‚ â”‚ 2. Replace manual PlaceDTO construction with placeMapper.toItineraryPlaceDTO()                                                                                                     â”‚ â”‚
â”‚ â”‚ 3. Add @Transactional(readOnly = true) to prevent lazy loading issues                                                                                                              â”‚ â”‚
â”‚ â”‚ 4. Ensure PlaceDTO is fully populated in responses                                                                                                                                 â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Phase 5: Fix Architectural Inconsistencies ğŸ—                                                                                                                                      â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ 1. Fix endpoint path: /api/itineraries/{id}/plan (add leading slash)                                                                                                               â”‚ â”‚
â”‚ â”‚ 2. Optional: Rename packages to lowercase (Recommendation â†’ recommendation, Interest â†’ interest)                                                                                   â”‚ â”‚
â”‚ â”‚ 3. Organize DTOs consistently                                                                                                                                                      â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Phase 6: Add Logging ğŸ“                                                                                                                                                            â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ 1. Add structured logging to PlanningServiceImpl (debug, info, error levels)                                                                                                       â”‚ â”‚
â”‚ â”‚ 2. Add request/response logging to PlanningController                                                                                                                              â”‚ â”‚
â”‚ â”‚ 3. Log AI call timing and errors                                                                                                                                                   â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Phase 7: Testing âœ…                                                                                                                                                                 â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ 1. Integration tests: auth, ownership, valid/invalid requests                                                                                                                      â”‚ â”‚
â”‚ â”‚ 2. Cross-module tests: itinerary â†’ recommendations â†’ interests â†’ planning flow                                                                                                     â”‚ â”‚
â”‚ â”‚ 3. Performance tests with large datasets                                                                                                                                           â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Phase 8: Documentation ğŸ“š                                                                                                                                                          â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ 1. Update PLANNING_MODULE.md with security and error handling                                                                                                                      â”‚ â”‚
â”‚ â”‚ 2. Add API documentation with examples                                                                                                                                             â”‚ â”‚
â”‚ â”‚ 3. Create INTEGRATION.md for cross-module workflows                                                                                                                                â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Estimated Effort: 19-29 hours (2.5-4 days)                                                                                                                                         â”‚ â”‚
â”‚ â”‚                                                                                                                                                                                    â”‚ â”‚
â”‚ â”‚ Key Decision: Choose AI integration approach (LangChain4j recommended for consistency)