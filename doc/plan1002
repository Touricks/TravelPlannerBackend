  å†³ç­–1ï¼šæ–°å¢å­—æ®µçš„å­˜å‚¨æ–¹å¼

  æ–¹æ¡ˆï¼šä½¿ç”¨ JSONB å­—æ®µå­˜å‚¨ç”¨æˆ·åå¥½

  - âœ… åœ¨ ItineraryEntity ä¸­æ–°å¢ userPreferences JSONB åˆ—
  - ç†ç”±ï¼š
    - è¿™äº›å­—æ®µä¸»è¦ç”¨äºä¼ ç»™ LLMï¼Œä¸éœ€è¦é¢‘ç¹æŸ¥è¯¢
    - é¿å…æ·»åŠ å¤§é‡åˆ—ï¼Œä¿æŒ schema ç®€æ´
    - çµæ´»æ€§é«˜ï¼Œåç»­è°ƒæ•´å­—æ®µæ— éœ€ migration
    - éµå¾ªç°æœ‰è®¾è®¡æ¨¡å¼ï¼ˆå·²æœ‰ aiMetadata, seededRecommendations JSONB å­—æ®µï¼‰

  å†³ç­–2ï¼šTravelMode å‘½å

  æ–¹æ¡ˆï¼šä¿æŒå­—æ®µåä¸º travelModeï¼Œåªæ”¹ enum å€¼

  - âœ… ä¿æŒå®ä½“å­—æ®µåï¼štravelMode
  - âœ… æ›´æ–° enum å€¼ï¼šæ·»åŠ  MIXED é€‰é¡¹
  - ç†ç”±ï¼š
    - é¿å…æ•°æ®åº“åˆ—é‡å‘½åçš„ migration å¤æ‚åº¦
    - travelMode å·²è¶³å¤Ÿè¡¨è¾¾å«ä¹‰

  å†³ç­–3ï¼šdailyStart/dailyEnd å¤„ç†

  æ–¹æ¡ˆï¼šä» Request ç§»é™¤ï¼Œä½†ä¿ç•™ Entity å­—æ®µ

  - âœ… ä» CreateItineraryRequest ç§»é™¤
  - âœ… ItineraryEntity ä¿ç•™å­—æ®µï¼ˆå…¼å®¹å·²æœ‰æ•°æ®ï¼‰
  - âœ… ItineraryServiceImpl ç§»é™¤ç›¸å…³æ˜ å°„é€»è¾‘
  - ç†ç”±ï¼š
    - è¿™äº›å­—æ®µåº”è¯¥åœ¨ PlanItineraryRequest ä¸­ä½¿ç”¨
    - ä¿ç•™ Entity å­—æ®µé¿å…ç ´åå·²æœ‰æ•°æ®

  ---
  ğŸ“ è¯¦ç»†ä¿®æ”¹æ¸…å•

  ç¬¬ä¸€æ­¥ï¼šæ–°å¢ Enum å®šä¹‰

  1.1 åˆ›å»º AttractionCategory.java

  ğŸ“ ä½ç½®ï¼š src/main/java/org/laioffer/planner/itinerary/model/common/AttractionCategory.java

  public enum AttractionCategory {
      MUSEUM,
      NATURE,
      FOOD,
      CULTURE,
      SHOPPING,
      ADVENTURE,
      NIGHTLIFE,
      HISTORICAL,
      ENTERTAINMENT,
      SPORTS,
      ART
  }

  1.2 åˆ›å»º TravelPace.java

  ğŸ“ ä½ç½®ï¼š src/main/java/org/laioffer/planner/itinerary/model/common/TravelPace.java

  public enum TravelPace {
      RELAXED,    // 2-3 POI/day
      MODERATE,   // 4-5 POI/day
      PACKED      // 6+ POI/day
  }

  1.3 åˆ›å»º ActivityIntensity.java

  ğŸ“ ä½ç½®ï¼š src/main/java/org/laioffer/planner/itinerary/model/common/ActivityIntensity.java

  public enum ActivityIntensity {
      LIGHT,      // minimal walking
      MODERATE,
      INTENSE     // hiking/sports
  }

  1.4 æ›´æ–° TravelMode.java

  ğŸ“ ä½ç½®ï¼š src/main/java/org/laioffer/planner/itinerary/model/common/TravelMode.java

  public enum TravelMode {
      DRIVING,
      TRANSIT,      // ä¿æŒç°æœ‰åç§°
      WALKING,
      BICYCLING,
      MIXED         // æ–°å¢
  }

  ---
  ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ CreateItineraryRequest

  2.1 æ›´æ–° CreateItineraryRequest.java

  ğŸ“ ä½ç½®ï¼š src/main/java/org/laioffer/planner/itinerary/model/common/CreateItineraryRequest.java

  ä¿®æ”¹å†…å®¹ï¼š
  1. âŒ ç§»é™¤ dailyStart, dailyEnd
  2. âœ… å°† budgetLimitCents æ·»åŠ  @NotNull æ³¨è§£
  3. âœ… æ·»åŠ æ–°å­—æ®µï¼š
    - preferredCategories: List<AttractionCategory>
    - numberOfTravelers: Integer
    - hasChildren: Boolean
    - hasElderly: Boolean
    - travelPace: TravelPace (æ ‡è®°ä¸º @NotNull)
    - activityIntensity: ActivityIntensity
    - preferPopularAttractions: Boolean
    - additionalPreferences: String

  ---
  ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹ ItineraryEntity

  3.1 æ›´æ–° ItineraryEntity.java

  ğŸ“ ä½ç½®ï¼š src/main/java/org/laioffer/planner/entity/ItineraryEntity.java

  ä¿®æ”¹å†…å®¹ï¼š
  1. âœ… æ–°å¢ JSONB å­—æ®µï¼š
  @Type(JsonType.class)
  @Column(name = "user_preferences", columnDefinition = "jsonb")
  private Map<String, Object> userPreferences;
  2. âœ… ä¿ç•™ dailyStart, dailyEnd å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
  3. âœ… æ·»åŠ  getter/setter for userPreferences

  ---
  ç¬¬å››æ­¥ï¼šä¿®æ”¹ ItineraryServiceImpl

  4.1 æ›´æ–° ItineraryServiceImpl.java

  ğŸ“ ä½ç½®ï¼š src/main/java/org/laioffer/planner/itinerary/ItineraryServiceImpl.java

  ä¿®æ”¹å†…å®¹ï¼š

  1. ç§»é™¤ dailyStart/dailyEnd æ˜ å°„é€»è¾‘ï¼š
  // åˆ é™¤è¿™äº›ä»£ç ï¼š
  // if (request.getDailyStart() != null) {
  //     itinerary.setDailyStart(parseTime(request.getDailyStart()));
  // }
  // if (request.getDailyEnd() != null) {
  //     itinerary.setDailyEnd(parseTime(request.getDailyEnd()));
  // }
  2. æ·»åŠ  userPreferences æ˜ å°„é€»è¾‘ï¼š
  // åœ¨ createItinerary æ–¹æ³•ä¸­æ·»åŠ ï¼š
  Map<String, Object> userPrefs = buildUserPreferences(request);
  itinerary.setUserPreferences(userPrefs);
  3. æ–°å¢è¾…åŠ©æ–¹æ³• buildUserPreferencesï¼š
  private Map<String, Object> buildUserPreferences(CreateItineraryRequest request) {
      Map<String, Object> prefs = new HashMap<>();

      if (request.getPreferredCategories() != null) {
          prefs.put("preferred_categories", request.getPreferredCategories());
      }
      if (request.getNumberOfTravelers() != null) {
          prefs.put("number_of_travelers", request.getNumberOfTravelers());
      }
      if (request.getHasChildren() != null) {
          prefs.put("has_children", request.getHasChildren());
      }
      if (request.getHasElderly() != null) {
          prefs.put("has_elderly", request.getHasElderly());
      }
      if (request.getTravelPace() != null) {
          prefs.put("travel_pace", request.getTravelPace().name());
      }
      if (request.getActivityIntensity() != null) {
          prefs.put("activity_intensity", request.getActivityIntensity().name());
      }
      if (request.getPreferPopularAttractions() != null) {
          prefs.put("prefer_popular_attractions", request.getPreferPopularAttractions());
      }
      if (request.getAdditionalPreferences() != null) {
          prefs.put("additional_preferences", request.getAdditionalPreferences());
      }

      return prefs;
  }
  4. æ›´æ–° calculatePOICount æ–¹æ³•ï¼ˆåŸºäº TravelPaceï¼‰ï¼š
  private int calculatePOICount(int stayingDays, TravelPace pace) {
      int poiPerDay = switch (pace) {
          case RELAXED -> 2;
          case MODERATE -> 4;
          case PACKED -> 6;
      };
      return Math.min(stayingDays * poiPerDay, MAX_POI_COUNT);
  }
  5. æ›´æ–° validateRequest æ–¹æ³•ï¼š
  // æ·»åŠ  budgetLimitCents å¿…å¡«æ ¡éªŒ
  if (request.getBudgetLimitCents() == null) {
      throw new IllegalArgumentException("Budget is required");
  }

  // æ·»åŠ  travelPace å¿…å¡«æ ¡éªŒ
  if (request.getTravelPace() == null) {
      throw new IllegalArgumentException("Travel pace is required");
  }

  // ç§»é™¤ dailyStart/dailyEnd çš„æ ¡éªŒé€»è¾‘
  6. ç§»é™¤ parseTime æ–¹æ³•ï¼ˆä¸å†éœ€è¦ï¼‰

  ---
  ç¬¬äº”æ­¥ï¼šæ•°æ®åº“ Migration

  5.1 åˆ›å»º Migration è„šæœ¬

  ğŸ“ ä½ç½®ï¼š src/main/resources/db/migration/V{version}__add_user_preferences_to_itinerary.sql

  -- æ·»åŠ  user_preferences JSONB åˆ—
  ALTER TABLE itineraries
  ADD COLUMN user_preferences JSONB DEFAULT '{}'::jsonb;

  -- ä¸º user_preferences æ·»åŠ  GIN ç´¢å¼•ï¼ˆå¯é€‰ï¼Œç”¨äºæŸ¥è¯¢ä¼˜åŒ–ï¼‰
  CREATE INDEX idx_itineraries_user_preferences
  ON itineraries USING GIN (user_preferences);

  -- æ›´æ–° TravelMode enumï¼ˆå¦‚æœéœ€è¦æ·»åŠ  MIXEDï¼‰
  -- æ³¨æ„ï¼šPostgreSQL enum æ›´æ–°éœ€è¦è°¨æ…æ“ä½œ
  ALTER TYPE travel_mode ADD VALUE IF NOT EXISTS 'MIXED';

  âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
  - å¦‚æœä½¿ç”¨ Flyway/Liquibaseï¼Œéœ€è¦ç¡®å®šç‰ˆæœ¬å·
  - å¦‚æœ travel_mode ä¸æ˜¯ç‹¬ç«‹çš„ enum typeï¼Œæ­¤æ­¥éª¤å¯èƒ½ä¸éœ€è¦

  ---
  ç¬¬å…­æ­¥ï¼šRepositoryï¼ˆæ— éœ€ä¿®æ”¹ï¼‰

  âœ… ItineraryRepository æ— éœ€ä¿®æ”¹
  - JSONB å­—æ®µç”± JPA/Hibernate è‡ªåŠ¨å¤„ç†
  - ç°æœ‰æŸ¥è¯¢æ–¹æ³•ä¸å—å½±å“

  ---
  ğŸ”„ å½±å“èŒƒå›´åˆ†æ

  âœ… éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ8ä¸ªï¼‰

  1. Enum å®šä¹‰ï¼ˆ4ä¸ªæ–°æ–‡ä»¶ï¼‰ï¼š
    - AttractionCategory.java
    - TravelPace.java
    - ActivityIntensity.java
    - TravelMode.javaï¼ˆæ›´æ–°ï¼‰
  2. Model/Requestï¼ˆ1ä¸ªï¼‰ï¼š
    - CreateItineraryRequest.java
  3. Entityï¼ˆ1ä¸ªï¼‰ï¼š
    - ItineraryEntity.java
  4. Serviceï¼ˆ1ä¸ªï¼‰ï¼š
    - ItineraryServiceImpl.java
  5. Database Migrationï¼ˆ1ä¸ªï¼‰ï¼š
    - V{version}__add_user_preferences_to_itinerary.sql

  âš ï¸ å¯èƒ½éœ€è¦åŒæ­¥æ›´æ–°çš„åœ°æ–¹

  1. æµ‹è¯•æ–‡ä»¶ï¼š
    - ItineraryControllerTest.java
    - ItineraryServiceImplTest.java
    - éœ€è¦æ›´æ–°æµ‹è¯•ç”¨ä¾‹ä¸­çš„ CreateItineraryRequest æ„é€ 
  2. Recommendation æ¨¡å—çš„é‡å¤ç±»ï¼š
    - å¦‚æœ org.laioffer.planner.Recommendation.model.itinerary.CreateItineraryRequest ä¹Ÿåœ¨ä½¿ç”¨ï¼Œéœ€è¦åŒæ­¥ä¿®æ”¹

  ---
  ğŸ“Š ä¿®æ”¹ä¼˜å…ˆçº§

  Phase 1 (æ ¸å¿ƒä¿®æ”¹ï¼Œå¿…é¡»å®Œæˆ):

  1. âœ… åˆ›å»ºæ–° Enum ç±»
  2. âœ… ä¿®æ”¹ CreateItineraryRequest
  3. âœ… ä¿®æ”¹ ItineraryEntity
  4. âœ… ä¿®æ”¹ ItineraryServiceImpl
  5. âœ… æ•°æ®åº“ Migration

  Phase 2 (å…¼å®¹æ€§ä¿®æ”¹):

  6. âš ï¸ æ›´æ–°æµ‹è¯•ç”¨ä¾‹
  7. âš ï¸ åŒæ­¥ Recommendation æ¨¡å—çš„ DTO

  ---
  âš¡ æ˜¯å¦éœ€è¦æ•°æ®åº“ Migrationï¼Ÿ

  æ˜¯çš„ï¼Œéœ€è¦ä½†å½±å“å¾ˆå°ï¼š
  - åªéœ€æ·»åŠ ä¸€ä¸ª JSONB åˆ— user_preferences
  - ä½¿ç”¨ DEFAULT '{}'::jsonbï¼Œå¯¹å·²æœ‰æ•°æ®æ— å½±å“
  - TravelMode æ·»åŠ  MIXED å€¼ï¼ˆå¦‚æœå­˜å‚¨ä¸º enum typeï¼‰

  ---
