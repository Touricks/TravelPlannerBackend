# Planning æ¨¡å—æŠ€æœ¯æ–‡æ¡£

## æ¦‚è¿°

Planning æ¨¡å—æ˜¯æ—…è¡Œè§„åˆ’ç³»ç»Ÿçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œè´Ÿè´£å°†ç”¨æˆ·çš„è¡Œç¨‹ä¿¡æ¯å’Œæ„Ÿå…´è¶£çš„åœ°ç‚¹é€šè¿‡ AI æ¨¡å‹ï¼ˆMCPï¼‰ç”Ÿæˆä¼˜åŒ–çš„æ—…è¡Œè®¡åˆ’ã€‚

## æ¶æ„è®¾è®¡

### æ¨¡å—ç»“æ„

```
org.laioffer.planner.planning/
â”œâ”€â”€ PlanningController.java           # API æ§åˆ¶å™¨
â”œâ”€â”€ PlanningService.java              # æœåŠ¡æ¥å£
â”œâ”€â”€ PlanningServiceImpl.java          # æœåŠ¡å®ç°
â”œâ”€â”€ exception/
â”‚   â””â”€â”€ ItineraryNotFoundException.java
â””â”€â”€ ai/
    â”œâ”€â”€ McpAiClient.java              # AI å®¢æˆ·ç«¯æ¥å£
    â”œâ”€â”€ McpAiClientImpl.java          # AI å®¢æˆ·ç«¯å®ç°
    â””â”€â”€ model/
        â”œâ”€â”€ AiPlanRequest.java        # AI è¯·æ±‚ DTO
        â”œâ”€â”€ AiPlanResponse.java       # AI å“åº” DTO
        â”œâ”€â”€ AiPlaceInfo.java          # åœ°ç‚¹ä¿¡æ¯ DTO
        â”œâ”€â”€ AiPlannedDay.java         # æ¯æ—¥è®¡åˆ’ DTO
        â””â”€â”€ AiPlannedStop.java        # ç«™ç‚¹è¯¦æƒ… DTO
```

---

## å®Œæ•´å·¥ä½œæµç¨‹

### 1. API å…¥å£

**ç«¯ç‚¹**: `POST /v1/itineraries/{itineraryId}/plan`

**è¯·æ±‚å‚æ•°**:
- **è·¯å¾„å‚æ•°**: `itineraryId` (UUID) - è¡Œç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦
- **è¯·æ±‚ä½“**: `PlanItineraryRequest`
  ```json
  {
    "interestPlaceIds": ["uuid-1", "uuid-2", "uuid-3"]  // å¯é€‰
  }
  ```

**å“åº”**: `PlanItineraryResponse` - åŒ…å«æŒ‰å¤©ç»„ç»‡çš„è¯¦ç»†æ—…è¡Œè®¡åˆ’

---

### 2. ä¸šåŠ¡é€»è¾‘æµç¨‹

#### æ­¥éª¤ 1: è·å–è¡Œç¨‹ä¿¡æ¯

```java
ItineraryEntity itinerary = itineraryRepository.findById(itineraryId)
    .orElseThrow(() -> new ItineraryNotFoundException(...));
```

**è·å–çš„è¡Œç¨‹ä¿¡æ¯åŒ…æ‹¬**:
- ç›®çš„åœ°åŸå¸‚ (`destinationCity`)
- æ—…è¡Œèµ·æ­¢æ—¥æœŸ (`startDate`, `endDate`)
- æ—…è¡Œæ¨¡å¼ (`travelMode`: WALKING, DRIVING, TRANSIT ç­‰)
- é¢„ç®— (`budgetInCents`: ä»¥åˆ†ä¸ºå•ä½)
- æ¯æ—¥æ´»åŠ¨æ—¶é—´ (`dailyStart`, `dailyEnd`: å¦‚ 09:00-20:00)

**å¼‚å¸¸å¤„ç†**:
- å¦‚æœè¡Œç¨‹ä¸å­˜åœ¨ï¼ŒæŠ›å‡º `ItineraryNotFoundException`

---

#### æ­¥éª¤ 2: è·å–ç”¨æˆ·æ„Ÿå…´è¶£çš„åœ°ç‚¹

```java
List<ItineraryPlaceEntity> interestedPlaces;
if (CollectionUtils.isEmpty(request.getInterestPlaceIds())) {
    // æ¨¡å¼ A: è·å–è¯¥è¡Œç¨‹ä¸‹æ‰€æœ‰çš„å…´è¶£ç‚¹
    interestedPlaces = itineraryPlaceRepository.findAllByItineraryId(itineraryId);
} else {
    // æ¨¡å¼ B: åªè·å–æŒ‡å®šçš„åœ°ç‚¹
    List<UUID> placeIds = request.getInterestPlaceIds().stream()
        .map(UUID::fromString).toList();
    interestedPlaces = itineraryPlaceRepository.findAllByItineraryIdAndIdIn(itineraryId, placeIds);
}
```

**æ”¯æŒä¸¤ç§æ¨¡å¼**:
- **å…¨éƒ¨å…´è¶£ç‚¹æ¨¡å¼**: ä½¿ç”¨ç”¨æˆ·ä¹‹å‰æ·»åŠ çš„æ‰€æœ‰æ„Ÿå…´è¶£åœ°ç‚¹
- **æŒ‡å®šåœ°ç‚¹æ¨¡å¼**: åªä½¿ç”¨æœ¬æ¬¡è¯·æ±‚ä¸­æŒ‡å®šçš„åœ°ç‚¹åˆ—è¡¨

---

#### æ­¥éª¤ 3: æ„å»º AI è¯·æ±‚

**æ–¹æ³•**: `buildAiRequest(itinerary, interestedPlaces)`

##### 3.1 è½¬æ¢è¡Œç¨‹çº¦æŸæ¡ä»¶

å°† `ItineraryEntity` çš„ä¿¡æ¯æ˜ å°„åˆ° `AiPlanRequest`:

| è¡Œç¨‹å­—æ®µ | AI è¯·æ±‚å­—æ®µ | è¯´æ˜ |
|---------|------------|------|
| destinationCity | destinationCity | ç›®çš„åœ°åŸå¸‚ |
| startDate | startDate | æ—…è¡Œå¼€å§‹æ—¥æœŸ |
| endDate | endDate | æ—…è¡Œç»“æŸæ—¥æœŸ |
| travelMode | travelMode | æ—…è¡Œæ¨¡å¼ï¼ˆè½¬ä¸ºå­—ç¬¦ä¸²ï¼‰ |
| budgetInCents | budgetInCents | é¢„ç®—ï¼ˆåˆ†ï¼‰ |
| dailyStart | dailyStart | æ¯æ—¥å¼€å§‹æ—¶é—´ |
| dailyEnd | dailyEnd | æ¯æ—¥ç»“æŸæ—¶é—´ |

##### 3.2 è½¬æ¢åœ°ç‚¹ä¿¡æ¯

**æ–¹æ³•**: `convertToAiPlaceInfo(itineraryPlace)`

å¯¹æ¯ä¸ª `ItineraryPlaceEntity`ï¼Œæå–å¹¶è½¬æ¢ä¸º `AiPlaceInfo`:

```java
AiPlaceInfo {
    placeId: UUID           // åœ°ç‚¹å”¯ä¸€ID
    name: String            // åœ°ç‚¹åç§°
    address: String         // è¯¦ç»†åœ°å€
    latitude: BigDecimal    // çº¬åº¦
    longitude: BigDecimal   // ç»åº¦
    description: String     // åœ°ç‚¹æè¿°
    pinned: boolean         // æ˜¯å¦æ ‡è®°ä¸ºå¿…å»
    note: String            // ç”¨æˆ·å¤‡æ³¨
}
```

**æ•°æ®æ¥æº**:
- åŸºç¡€ä¿¡æ¯æ¥è‡ª `ItineraryPlaceEntity`
- è¯¦ç»†ä¿¡æ¯ï¼ˆåœ°å€ã€åæ ‡ã€æè¿°ï¼‰æ¥è‡ªå…³è”çš„ `PlaceEntity`

---

#### æ­¥éª¤ 4: è°ƒç”¨ AI æ¨¡å‹

```java
AiPlanResponse aiResponse = mcpAiClient.generatePlan(aiRequest);
```

**McpAiClient å®ç°**:
- ä½¿ç”¨ Spring çš„ `RestTemplate` å‘èµ· HTTP POST è¯·æ±‚
- ç›®æ ‡ URL: é€šè¿‡é…ç½®é¡¹ `ai.mcp.service.url` æŒ‡å®š
  - é»˜è®¤å€¼: `http://localhost:8080/ai/plan`
- è¯·æ±‚ä½“: `AiPlanRequest` (JSON åºåˆ—åŒ–)
- å“åº”: `AiPlanResponse` (JSON ååºåˆ—åŒ–)

**AI å“åº”ç¤ºä¾‹**:

```json
{
  "summary": "ä¸ºæœŸ3å¤©çš„åŒ—äº¬æ–‡åŒ–ä¹‹æ—…",
  "days": [
    {
      "date": "2025-10-15",
      "summary": "æ¢ç´¢å¸‚ä¸­å¿ƒå†å²æ–‡åŒ–åŒº",
      "stops": [
        {
          "placeId": "550e8400-e29b-41d4-a716-446655440000",
          "placeName": "æ•…å®«åšç‰©é™¢",
          "arrivalTime": "09:00",
          "departureTime": "12:00",
          "durationMinutes": 180,
          "activity": "å‚è§‚å¤å»ºç­‘å’Œæ–‡ç‰©å±•è§ˆ",
          "transportMode": "æ­¥è¡Œ",
          "transportDurationMinutes": 15
        },
        {
          "placeId": "550e8400-e29b-41d4-a716-446655440001",
          "placeName": "æ™¯å±±å…¬å›­",
          "arrivalTime": "12:30",
          "departureTime": "14:00",
          "durationMinutes": 90,
          "activity": "ç™»é«˜ä¿¯ç°ç´«ç¦åŸå…¨æ™¯",
          "transportMode": "æ­¥è¡Œ",
          "transportDurationMinutes": 10
        }
      ]
    }
  ]
}
```

---

#### æ­¥éª¤ 5: å¤„ç† AI å“åº”

**æ–¹æ³•**: `buildPlanResponse(aiResponse)`

##### 5.1 è½¬æ¢æ¯æ—¥è®¡åˆ’

**æ–¹æ³•**: `convertToPlannedDay(aiDay)`

è½¬æ¢é€»è¾‘:

```java
PlannedDay {
    date: String              // LocalDate â†’ String (å¦‚ "2025-10-15")
    summary: String           // æ¯æ—¥æ¦‚è¦ï¼ˆå¯é€‰ï¼‰
    stops: List<PlannedStop>  // è¯¥å¤©çš„ç«™ç‚¹åˆ—è¡¨
}
```

##### 5.2 è½¬æ¢ç«™ç‚¹ä¿¡æ¯

**æ–¹æ³•**: `convertToPlannedStop(aiStop)`

å­—æ®µæ˜ å°„:

| AI å­—æ®µ | API å­—æ®µ | è½¬æ¢é€»è¾‘ |
|---------|---------|---------|
| arrivalTime | arrivalLocal | LocalTime â†’ String |
| departureTime | departLocal | LocalTime â†’ String |
| durationMinutes | stayMinutes | ç›´æ¥æ˜ å°„ |
| activity | note | æ´»åŠ¨æè¿°ä½œä¸ºå¤‡æ³¨ |

> **æ³¨æ„**: å½“å‰å®ç°ä¸­æœªå®Œæ•´å¡«å…… `PlaceDTO` å¯¹è±¡ï¼Œåç»­å¯èƒ½éœ€è¦ä»æ•°æ®åº“æŸ¥è¯¢å®Œæ•´åœ°ç‚¹ä¿¡æ¯ã€‚

---

#### æ­¥éª¤ 6: è¿”å›æœ€ç»ˆè®¡åˆ’

```java
return buildPlanResponse(aiResponse);
```

- `PlanningServiceImpl` è¿”å› `PlanItineraryResponse`
- `PlanningController` å°†å…¶åŒ…è£…åœ¨ HTTP 200 å“åº”ä¸­
- å‰ç«¯æ¥æ”¶å®Œæ•´çš„æ—…è¡Œè®¡åˆ’

---

## æ•°æ®æµè½¬å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‰ç«¯åº”ç”¨                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ POST /v1/itineraries/{id}/plan
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PlanningController                            â”‚
â”‚  - æ¥æ”¶ itineraryId + PlanItineraryRequest                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PlanningServiceImpl                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Step 1: ä»æ•°æ®åº“è·å– ItineraryEntity                            â”‚
â”‚          â†“                                                       â”‚
â”‚  Step 2: ä»æ•°æ®åº“è·å– List<ItineraryPlaceEntity>                 â”‚
â”‚          â†“                                                       â”‚
â”‚  Step 3: æ„å»º AiPlanRequest                                      â”‚
â”‚          - è¡Œç¨‹çº¦æŸ (æ—¥æœŸã€é¢„ç®—ã€æ—¶é—´ç­‰)                           â”‚
â”‚          - åœ°ç‚¹åˆ—è¡¨ (åç§°ã€åæ ‡ã€æè¿°ç­‰)                           â”‚
â”‚          â†“                                                       â”‚
â”‚  Step 4: è°ƒç”¨ McpAiClient.generatePlan()                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP POST
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MCP AI æœåŠ¡                                 â”‚
â”‚  - åˆ†æè¡Œç¨‹çº¦æŸ                                                   â”‚
â”‚  - ä¼˜åŒ–åœ°ç‚¹é¡ºåº                                                   â”‚
â”‚  - è®¡ç®—è·¯çº¿å’Œæ—¶é—´                                                 â”‚
â”‚  - ç”Ÿæˆæ¯æ—¥è®¡åˆ’                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ AiPlanResponse
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PlanningServiceImpl                            â”‚
â”‚  Step 5: è½¬æ¢ AI å“åº”ä¸º API æ ¼å¼                                  â”‚
â”‚          - AiPlannedDay â†’ PlannedDay                             â”‚
â”‚          - AiPlannedStop â†’ PlannedStop                           â”‚
â”‚          â†“                                                       â”‚
â”‚  Step 6: è¿”å› PlanItineraryResponse                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å‰ç«¯åº”ç”¨                                 â”‚
â”‚  æ˜¾ç¤ºä¼˜åŒ–åçš„æ—…è¡Œè®¡åˆ’                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### âœ… æ™ºèƒ½è·¯çº¿ä¼˜åŒ–
AI æ¨¡å‹ä¼šç»¼åˆè€ƒè™‘ï¼š
- åœ°ç‚¹é—´çš„åœ°ç†è·ç¦»
- åœ°ç‚¹çš„å¼€æ”¾æ—¶é—´
- æ¨èçš„æ¸¸ç©æ—¶é•¿
- æœ€ä¼˜çš„äº¤é€šæ–¹å¼

### âœ… æ—¶é—´çº¦æŸç®¡ç†
- éµå®ˆç”¨æˆ·è®¾å®šçš„æ¯æ—¥æ´»åŠ¨æ—¶é—´ï¼ˆå¦‚ 9:00-20:00ï¼‰
- è‡ªåŠ¨åˆ†é…æ¯ä¸ªåœ°ç‚¹çš„åˆ°è¾¾å’Œç¦»å¼€æ—¶é—´
- ç¡®ä¿è¡Œç¨‹ä¸ä¼šè¿‡äºç´§å‡‘æˆ–æ¾æ•£

### âœ… é¢„ç®—æ„ŸçŸ¥
- AI å¯æ ¹æ®é¢„ç®—è°ƒæ•´æ¨èçš„æ´»åŠ¨ç±»å‹
- ä¼˜åŒ–äº¤é€šæ–¹å¼é€‰æ‹©ï¼ˆå¦‚é¢„ç®—ç´§å¼ æ—¶æ¨èå…¬å…±äº¤é€šï¼‰

### âœ… çµæ´»çš„åœ°ç‚¹é€‰æ‹©
- **å…¨é‡æ¨¡å¼**: ä½¿ç”¨æ‰€æœ‰ç”¨æˆ·æ„Ÿå…´è¶£çš„åœ°ç‚¹
- **ç²¾é€‰æ¨¡å¼**: ä»…ä½¿ç”¨è¯·æ±‚ä¸­æŒ‡å®šçš„åœ°ç‚¹å­é›†

### âœ… ä¼˜å…ˆçº§å¤„ç†
- `pinned` æ ‡è®°çš„åœ°ç‚¹ä¼šè¢«ä¼˜å…ˆå®‰æ’
- ç¡®ä¿å¿…å»æ™¯ç‚¹ä¸ä¼šè¢«é—æ¼

### âœ… å¼‚å¸¸å¤„ç†
- è¡Œç¨‹ä¸å­˜åœ¨: è¿”å› `404 Not Found` + `ItineraryNotFoundException`
- AI æœåŠ¡ä¸å¯ç”¨: æŠ›å‡ºç›¸åº”å¼‚å¸¸ï¼ˆéœ€é…ç½®é”™è¯¯å¤„ç†ï¼‰

---

## é…ç½®è¯´æ˜

### å¿…éœ€é…ç½®

åœ¨ `application.yml` æˆ– `application.properties` ä¸­æ·»åŠ ï¼š

```yaml
ai:
  mcp:
    service:
      url: http://your-ai-service-domain/api/plan
```

æˆ–

```properties
ai.mcp.service.url=http://your-ai-service-domain/api/plan
```

### é»˜è®¤å€¼

å¦‚æœæœªé…ç½®ï¼Œé»˜è®¤ä½¿ç”¨ï¼š`http://localhost:8080/ai/plan`

---

## ä¾èµ–å…³ç³»

### Spring Bean ä¾èµ–

```
PlanningController
    â†“
PlanningServiceImpl
    â”œâ”€â†’ ItineraryRepository
    â”œâ”€â†’ ItineraryPlaceRepository
    â””â”€â†’ McpAiClient
            â””â”€â†’ RestTemplate (é…ç½®åœ¨ AppConfig)
```

### å®ä½“å…³ç³»

```
ItineraryEntity (è¡Œç¨‹)
    â†“ 1:N
ItineraryPlaceEntity (è¡Œç¨‹-åœ°ç‚¹å…³è”)
    â†“ N:1
PlaceEntity (åœ°ç‚¹è¯¦æƒ…)
```

---

## API ä½¿ç”¨ç¤ºä¾‹

### è¯·æ±‚ç¤ºä¾‹ 1: ä½¿ç”¨æ‰€æœ‰å…´è¶£ç‚¹

```bash
POST /v1/itineraries/550e8400-e29b-41d4-a716-446655440000/plan
Content-Type: application/json

{
  "interestPlaceIds": []
}
```

### è¯·æ±‚ç¤ºä¾‹ 2: ä½¿ç”¨æŒ‡å®šåœ°ç‚¹

```bash
POST /v1/itineraries/550e8400-e29b-41d4-a716-446655440000/plan
Content-Type: application/json

{
  "interestPlaceIds": [
    "550e8400-e29b-41d4-a716-446655440001",
    "550e8400-e29b-41d4-a716-446655440002",
    "550e8400-e29b-41d4-a716-446655440003"
  ]
}
```

### å“åº”ç¤ºä¾‹

```json
{
  "days": [
    {
      "date": "2025-10-15",
      "stops": [
        {
          "order": 1,
          "place": { /* PlaceDTO å¯¹è±¡ */ },
          "arrivalLocal": "09:00",
          "departLocal": "12:00",
          "stayMinutes": 180,
          "note": "å‚è§‚å¤å»ºç­‘å’Œæ–‡ç‰©å±•è§ˆ"
        }
      ]
    }
  ]
}
```

---

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Spring Boot
- **æŒä¹…å±‚**: Spring Data JPA (Hibernate)
- **æ•°æ®åº“**: PostgreSQL (with PostGIS extension)
- **HTTP å®¢æˆ·ç«¯**: RestTemplate
- **JSON åºåˆ—åŒ–**: Jackson
- **ä¾èµ–æ³¨å…¥**: Spring IoC

---

## å®Œæ•´æµç¨‹ç¤ºä¾‹

ä¸ºäº†æ›´å¥½åœ°ç†è§£æ•´ä¸ªç³»ç»Ÿçš„å·¥ä½œæµç¨‹ï¼Œä»¥ä¸‹æ˜¯ä¸€ä¸ªçœŸå®åœºæ™¯çš„å®Œæ•´æ¨¡æ‹Ÿã€‚

### åœºæ™¯è®¾å®š

**ç”¨æˆ·**: å¼ ä¸‰ï¼Œè®¡åˆ’åœ¨åŒ—äº¬è¿›è¡Œä¸ºæœŸ 3 å¤©çš„æ–‡åŒ–ä¹‹æ—…

**æ—…è¡Œä¿¡æ¯**:
- ç›®çš„åœ°ï¼šåŒ—äº¬
- æ—¥æœŸï¼š2025-10-15 è‡³ 2025-10-17
- é¢„ç®—ï¼šÂ¥1500ï¼ˆ150000 åˆ†ï¼‰
- æ¯æ—¥æ´»åŠ¨æ—¶é—´ï¼š09:00 - 20:00
- æ—…è¡Œæ¨¡å¼ï¼šå…¬å…±äº¤é€š + æ­¥è¡Œ

**æ„Ÿå…´è¶£çš„åœ°ç‚¹**ï¼ˆç”¨æˆ·å·²æå‰é€‰æ‹©ï¼‰:
1. æ•…å®«åšç‰©é™¢
2. å¤©å®‰é—¨å¹¿åœº
3. æ™¯å±±å…¬å›­
4. å¤©å›å…¬å›­
5. é¢å’Œå›­
6. åœ†æ˜å›­
7. å—é”£é¼“å··
8. ä»€åˆ¹æµ·

---

### Step 1: å‰ç«¯å‘èµ·è¯·æ±‚

```http
POST /v1/itineraries/a1b2c3d4-e5f6-7890-abcd-ef1234567890/plan HTTP/1.1
Host: api.travelplanner.com
Content-Type: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

{
  "interestPlaceIds": []
}
```

> **è¯´æ˜**: `interestPlaceIds` ä¸ºç©ºï¼Œè¡¨ç¤ºä½¿ç”¨è¯¥è¡Œç¨‹ä¸‹çš„æ‰€æœ‰æ„Ÿå…´è¶£åœ°ç‚¹

---

### Step 2: æœåŠ¡å±‚æŸ¥è¯¢æ•°æ®åº“

#### 2.1 æŸ¥è¯¢è¡Œç¨‹ä¿¡æ¯

**æ•°æ®åº“æŸ¥è¯¢**: `SELECT * FROM itineraries WHERE id = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'`

**æŸ¥è¯¢ç»“æœ** (`ItineraryEntity`):

```json
{
  "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "userId": 1001,
  "destinationCity": "åŒ—äº¬",
  "startDate": "2025-10-15T00:00:00+08:00",
  "endDate": "2025-10-17T23:59:59+08:00",
  "travelMode": "TRANSIT",
  "budgetInCents": 150000,
  "dailyStart": "09:00:00",
  "dailyEnd": "20:00:00",
  "createdAt": "2025-10-08T14:30:00",
  "updatedAt": "2025-10-08T14:30:00"
}
```

#### 2.2 æŸ¥è¯¢æ„Ÿå…´è¶£çš„åœ°ç‚¹

**æ•°æ®åº“æŸ¥è¯¢**: `SELECT * FROM itinerary_places WHERE itinerary_id = '...'`

**æŸ¥è¯¢ç»“æœ** (`List<ItineraryPlaceEntity>` - å…± 8 ä¸ªåœ°ç‚¹):

```json
[
  {
    "id": "place-link-001",
    "itineraryId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "placeId": "place-001",
    "name": "æ•…å®«åšç‰©é™¢",
    "description": "ä¸­å›½æ˜æ¸…ä¸¤ä»£çš„çš‡å®¶å®«æ®¿ï¼Œä¸–ç•Œæ–‡åŒ–é—äº§",
    "pinned": true,
    "note": "å¿…å»æ™¯ç‚¹ï¼Œæå‰é¢„çº¦é—¨ç¥¨",
    "addedAt": "2025-10-08T15:00:00",
    "place": {
      "id": "place-001",
      "name": "æ•…å®«åšç‰©é™¢",
      "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºæ™¯å±±å‰è¡—4å·",
      "latitude": 39.916345,
      "longitude": 116.397026,
      "description": "ä¸–ç•Œä¸Šç°å­˜è§„æ¨¡æœ€å¤§ã€ä¿å­˜æœ€ä¸ºå®Œæ•´çš„æœ¨è´¨ç»“æ„å¤å»ºç­‘ä¹‹ä¸€"
    }
  },
  {
    "id": "place-link-002",
    "itineraryId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "placeId": "place-002",
    "name": "å¤©å®‰é—¨å¹¿åœº",
    "description": "ä¸–ç•Œä¸Šæœ€å¤§çš„åŸå¸‚å¹¿åœºä¹‹ä¸€",
    "pinned": true,
    "note": null,
    "addedAt": "2025-10-08T15:01:00",
    "place": {
      "id": "place-002",
      "name": "å¤©å®‰é—¨å¹¿åœº",
      "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºé•¿å®‰è¡—",
      "latitude": 39.903828,
      "longitude": 116.391136,
      "description": "ä½äºåŒ—äº¬å¸‚ä¸­å¿ƒï¼Œæ˜¯ä¸­å›½çš„è±¡å¾"
    }
  },
  {
    "id": "place-link-003",
    "placeId": "place-003",
    "name": "æ™¯å±±å…¬å›­",
    "pinned": false,
    "place": {
      "latitude": 39.921629,
      "longitude": 116.395592
    }
  },
  {
    "id": "place-link-004",
    "placeId": "place-004",
    "name": "å¤©å›å…¬å›­",
    "pinned": false,
    "place": {
      "latitude": 39.882217,
      "longitude": 116.407395
    }
  },
  {
    "id": "place-link-005",
    "placeId": "place-005",
    "name": "é¢å’Œå›­",
    "pinned": true,
    "note": "æƒ³çœ‹æ˜†æ˜æ¹–å’Œé•¿å»Š",
    "place": {
      "latitude": 39.999439,
      "longitude": 116.275352
    }
  },
  {
    "id": "place-link-006",
    "placeId": "place-006",
    "name": "åœ†æ˜å›­",
    "pinned": false,
    "place": {
      "latitude": 40.007554,
      "longitude": 116.297662
    }
  },
  {
    "id": "place-link-007",
    "placeId": "place-007",
    "name": "å—é”£é¼“å··",
    "pinned": false,
    "place": {
      "latitude": 39.937674,
      "longitude": 116.402893
    }
  },
  {
    "id": "place-link-008",
    "placeId": "place-008",
    "name": "ä»€åˆ¹æµ·",
    "pinned": false,
    "place": {
      "latitude": 39.939083,
      "longitude": 116.389441
    }
  }
]
```

---

### Step 3: æ„å»º AI è¯·æ±‚

**å¤„ç†é€»è¾‘**: `buildAiRequest(itinerary, interestedPlaces)`

**ç”Ÿæˆçš„ AI è¯·æ±‚** (`AiPlanRequest`):

```json
{
  "destinationCity": "åŒ—äº¬",
  "startDate": "2025-10-15T00:00:00+08:00",
  "endDate": "2025-10-17T23:59:59+08:00",
  "travelMode": "TRANSIT",
  "budgetInCents": 150000,
  "dailyStart": "09:00:00",
  "dailyEnd": "20:00:00",
  "interestedPlaces": [
    {
      "placeId": "place-001",
      "name": "æ•…å®«åšç‰©é™¢",
      "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºæ™¯å±±å‰è¡—4å·",
      "latitude": 39.916345,
      "longitude": 116.397026,
      "description": "ä¸–ç•Œä¸Šç°å­˜è§„æ¨¡æœ€å¤§ã€ä¿å­˜æœ€ä¸ºå®Œæ•´çš„æœ¨è´¨ç»“æ„å¤å»ºç­‘ä¹‹ä¸€",
      "pinned": true,
      "note": "å¿…å»æ™¯ç‚¹ï¼Œæå‰é¢„çº¦é—¨ç¥¨"
    },
    {
      "placeId": "place-002",
      "name": "å¤©å®‰é—¨å¹¿åœº",
      "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºé•¿å®‰è¡—",
      "latitude": 39.903828,
      "longitude": 116.391136,
      "description": "ä½äºåŒ—äº¬å¸‚ä¸­å¿ƒï¼Œæ˜¯ä¸­å›½çš„è±¡å¾",
      "pinned": true,
      "note": null
    },
    {
      "placeId": "place-003",
      "name": "æ™¯å±±å…¬å›­",
      "address": "åŒ—äº¬å¸‚è¥¿åŸåŒºæ™¯å±±è¥¿è¡—44å·",
      "latitude": 39.921629,
      "longitude": 116.395592,
      "description": "å¯ç™»é«˜ä¿¯ç°ç´«ç¦åŸå…¨æ™¯",
      "pinned": false,
      "note": null
    },
    {
      "placeId": "place-004",
      "name": "å¤©å›å…¬å›­",
      "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºå¤©å›è·¯",
      "latitude": 39.882217,
      "longitude": 116.407395,
      "description": "æ˜æ¸…ä¸¤ä»£çš‡å¸ç¥­å¤©ç¥ˆè°·çš„åœºæ‰€",
      "pinned": false,
      "note": null
    },
    {
      "placeId": "place-005",
      "name": "é¢å’Œå›­",
      "address": "åŒ—äº¬å¸‚æµ·æ·€åŒºæ–°å»ºå®«é—¨è·¯19å·",
      "latitude": 39.999439,
      "longitude": 116.275352,
      "description": "ä¸­å›½ç°å­˜è§„æ¨¡æœ€å¤§çš„çš‡å®¶å›­æ—",
      "pinned": true,
      "note": "æƒ³çœ‹æ˜†æ˜æ¹–å’Œé•¿å»Š"
    },
    {
      "placeId": "place-006",
      "name": "åœ†æ˜å›­",
      "address": "åŒ—äº¬å¸‚æµ·æ·€åŒºæ¸…åè¥¿è·¯28å·",
      "latitude": 40.007554,
      "longitude": 116.297662,
      "description": "æ¸…ä»£çš‡å®¶å›­æ—é—å€",
      "pinned": false,
      "note": null
    },
    {
      "placeId": "place-007",
      "name": "å—é”£é¼“å··",
      "address": "åŒ—äº¬å¸‚ä¸œåŸåŒºå—é”£é¼“å··",
      "latitude": 39.937674,
      "longitude": 116.402893,
      "description": "åŒ—äº¬æœ€å¤è€çš„è¡—åŒºä¹‹ä¸€ï¼Œç°ä¸ºæ–‡è‰ºå°åº—èšé›†åœ°",
      "pinned": false,
      "note": null
    },
    {
      "placeId": "place-008",
      "name": "ä»€åˆ¹æµ·",
      "address": "åŒ—äº¬å¸‚è¥¿åŸåŒºç¾Šæˆ¿èƒ¡åŒ",
      "latitude": 39.939083,
      "longitude": 116.389441,
      "description": "åŒ—äº¬å†…åŸå”¯ä¸€ä¸€å¤„å…·æœ‰å¼€é˜”æ°´é¢çš„å¼€æ”¾æ™¯åŒº",
      "pinned": false,
      "note": null
    }
  ]
}
```

---

### Step 4: AI æ¨¡å‹å¤„ç†

**HTTP è¯·æ±‚**:

```http
POST /api/plan HTTP/1.1
Host: ai.mcp-service.internal
Content-Type: application/json

{è¯·æ±‚ä½“å¦‚ä¸Š}
```

**AI åˆ†æè¿‡ç¨‹** (å†…éƒ¨é€»è¾‘):

1. **æ—¥æœŸåˆ†æ**: 3 å¤©è¡Œç¨‹ï¼ˆ10æœˆ15æ—¥-17æ—¥ï¼‰
2. **æ—¶é—´çº¦æŸ**: æ¯å¤© 09:00-20:00ï¼Œæœ‰æ•ˆæ—¶é—´ 11 å°æ—¶
3. **åœ°ç‚¹åˆ†æ**:
   - 8 ä¸ªåœ°ç‚¹éœ€è¦å®‰æ’
   - 3 ä¸ªå¿…å»åœ°ç‚¹ï¼ˆpinnedï¼‰: æ•…å®«ã€å¤©å®‰é—¨ã€é¢å’Œå›­
   - åœ°ç‚¹åœ°ç†åˆ†å¸ƒï¼šå¸‚ä¸­å¿ƒï¼ˆæ•…å®«ã€å¤©å®‰é—¨ã€æ™¯å±±ã€å—é”£é¼“å··ã€ä»€åˆ¹æµ·ï¼‰ã€è¥¿åŒ—éƒŠï¼ˆé¢å’Œå›­ã€åœ†æ˜å›­ï¼‰ã€å—éƒ¨ï¼ˆå¤©å›ï¼‰
4. **è·¯çº¿ä¼˜åŒ–**:
   - Day 1: å¸‚ä¸­å¿ƒå†å²æ ¸å¿ƒåŒºï¼ˆå¤©å®‰é—¨ â†’ æ•…å®« â†’ æ™¯å±± â†’ å—é”£é¼“å·· â†’ ä»€åˆ¹æµ·ï¼‰
   - Day 2: çš‡å®¶å›­æ—ï¼ˆé¢å’Œå›­ â†’ åœ†æ˜å›­ï¼‰
   - Day 3: å¤©å› + æœºåŠ¨æ—¶é—´
5. **äº¤é€šè§„åˆ’**: ä¼˜å…ˆä½¿ç”¨åœ°é“ï¼Œæ™¯ç‚¹é—´æ­¥è¡Œ
6. **æ—¶é—´åˆ†é…**: æ ¹æ®æ™¯ç‚¹æ¨èæ¸¸ç©æ—¶é•¿å’Œå¼€æ”¾æ—¶é—´

**AI è¿”å›ç»“æœ** (`AiPlanResponse`):

```json
{
  "summary": "ä¸‰å¤©ä¸¤æ™šåŒ—äº¬çš‡åŸæ–‡åŒ–æ·±åº¦æ¸¸ï¼Œæ¢ç´¢æ˜æ¸…çš‡å®¶å»ºç­‘ä¸ä¼ ç»Ÿèƒ¡åŒæ–‡åŒ–ï¼Œè¡Œç¨‹æ¾å¼›æœ‰åº¦ï¼Œé€‚åˆæ–‡åŒ–çˆ±å¥½è€…ã€‚",
  "days": [
    {
      "date": "2025-10-15",
      "summary": "Day 1: æ¢ç´¢å¤©å®‰é—¨-æ•…å®«æ ¸å¿ƒåŒºï¼Œæ„Ÿå—çš‡åŸå¨ä¸¥ä¸èƒ¡åŒé£æƒ…",
      "stops": [
        {
          "placeId": "place-002",
          "placeName": "å¤©å®‰é—¨å¹¿åœº",
          "arrivalTime": "09:00",
          "departureTime": "10:00",
          "durationMinutes": 60,
          "activity": "è§‚çœ‹å‡æ——ä»ªå¼ï¼ˆå¦‚éœ€è¦è¯·æå‰åˆ°è¾¾ï¼‰ï¼Œå‚è§‚å¹¿åœºå‘¨è¾¹å»ºç­‘ï¼Œæ‹ç…§ç•™å¿µ",
          "transportMode": null,
          "transportDurationMinutes": 0
        },
        {
          "placeId": "place-001",
          "placeName": "æ•…å®«åšç‰©é™¢",
          "arrivalTime": "10:15",
          "departureTime": "14:00",
          "durationMinutes": 225,
          "activity": "æ·±åº¦æ¸¸è§ˆå¤ªå’Œæ®¿ã€ä¸­å’Œæ®¿ã€ä¿å’Œæ®¿ç­‰ä¸‰å¤§æ®¿ï¼Œåå®«åŒºåŸŸå’Œçå®é¦†ï¼Œå»ºè®®æŒ‰ä¸­è½´çº¿æ¸¸è§ˆ",
          "transportMode": "æ­¥è¡Œ",
          "transportDurationMinutes": 15
        },
        {
          "placeId": "place-003",
          "placeName": "æ™¯å±±å…¬å›­",
          "arrivalTime": "14:30",
          "departureTime": "16:00",
          "durationMinutes": 90,
          "activity": "ç™»é¡¶ä¸‡æ˜¥äº­ï¼Œ360åº¦ä¿¯ç°ç´«ç¦åŸå…¨æ™¯ï¼Œæ˜¯æ‹æ‘„æ•…å®«æœ€ä½³æœºä½",
          "transportMode": "æ­¥è¡Œ",
          "transportDurationMinutes": 30
        },
        {
          "placeId": "place-007",
          "placeName": "å—é”£é¼“å··",
          "arrivalTime": "16:45",
          "departureTime": "18:30",
          "durationMinutes": 105,
          "activity": "æ¼«æ­¥èƒ¡åŒï¼Œæ¢è®¿æ–‡è‰ºå°åº—ã€å’–å•¡é¦†å’Œç‰¹è‰²é¤å…ï¼Œå“å°åŒ—äº¬å°åƒ",
          "transportMode": "åœ°é“8å·çº¿",
          "transportDurationMinutes": 45
        },
        {
          "placeId": "place-008",
          "placeName": "ä»€åˆ¹æµ·",
          "arrivalTime": "19:00",
          "departureTime": "20:00",
          "durationMinutes": 60,
          "activity": "å¤œæ¸¸ä»€åˆ¹æµ·ï¼Œæ¬£èµæ¹–ç•”å¤œæ™¯ï¼Œå¯é€‰æ‹©åœ¨æ¹–è¾¹é…’å§å°æ†©æˆ–ä¹˜èˆ¹æ¸¸è§ˆ",
          "transportMode": "æ­¥è¡Œ",
          "transportDurationMinutes": 30
        }
      ]
    },
    {
      "date": "2025-10-16",
      "summary": "Day 2: è¥¿éƒŠçš‡å®¶å›­æ—å·¡ç¤¼ï¼Œé¢†ç•¥çš‡å®¶é€ å›­è‰ºæœ¯",
      "stops": [
        {
          "placeId": "place-005",
          "placeName": "é¢å’Œå›­",
          "arrivalTime": "09:00",
          "departureTime": "13:30",
          "durationMinutes": 270,
          "activity": "æ¸¸è§ˆä¸‡å¯¿å±±ã€ä½›é¦™é˜ã€é•¿å»Šï¼ˆ728ç±³å½©ç”»é•¿å»Šï¼‰ã€æ˜†æ˜æ¹–ï¼Œå»ºè®®ç§Ÿèˆ¹æ¸¸æ¹–æˆ–æ²¿æ¹–æ¼«æ­¥",
          "transportMode": "åœ°é“4å·çº¿",
          "transportDurationMinutes": 60
        },
        {
          "placeId": "place-006",
          "placeName": "åœ†æ˜å›­",
          "arrivalTime": "14:30",
          "departureTime": "17:30",
          "durationMinutes": 180,
          "activity": "å‚è§‚å¤§æ°´æ³•é—å€ç­‰è¥¿æ´‹æ¥¼æ™¯åŒºï¼Œäº†è§£åœ†æ˜å›­å†å²ï¼Œæ„Ÿå—çš‡å®¶å›­æ—çš„æ²§æ¡‘å˜è¿",
          "transportMode": "å…¬äº¤",
          "transportDurationMinutes": 60
        }
      ]
    },
    {
      "date": "2025-10-17",
      "summary": "Day 3: å¤©å›ç¥ˆç¦ï¼Œåœ†æ»¡ç»“æŸåŒ—äº¬æ–‡åŒ–ä¹‹æ—…",
      "stops": [
        {
          "placeId": "place-004",
          "placeName": "å¤©å›å…¬å›­",
          "arrivalTime": "09:00",
          "departureTime": "12:00",
          "durationMinutes": 180,
          "activity": "æ¸¸è§ˆç¥ˆå¹´æ®¿ã€å›éŸ³å£ã€åœœä¸˜ï¼Œè§‚çœ‹è€åŒ—äº¬æ™¨ç»ƒæ–‡åŒ–ï¼Œä½“éªŒå›éŸ³å£çš„å¥‡å¦™å£°å­¦æ•ˆæœ",
          "transportMode": "åœ°é“5å·çº¿",
          "transportDurationMinutes": 45
        }
      ]
    }
  ]
}
```

**AI ä¼˜åŒ–è¯´æ˜**:
- âœ… å¿…å»æ™¯ç‚¹å…¨éƒ¨å®‰æ’ï¼ˆæ•…å®«ã€å¤©å®‰é—¨ã€é¢å’Œå›­ï¼‰
- âœ… åœ°ç†ä½ç½®ç›¸è¿‘çš„æ™¯ç‚¹å®‰æ’åœ¨åŒä¸€å¤©ï¼ˆå¸‚ä¸­å¿ƒ / è¥¿éƒŠåˆ†ç»„ï¼‰
- âœ… éµå®ˆæ¯æ—¥æ´»åŠ¨æ—¶é—´ï¼ˆ09:00-20:00ï¼‰
- âœ… åˆç†åˆ†é…æ¸¸è§ˆæ—¶é•¿ï¼ˆæ•…å®« 3.75 å°æ—¶ï¼Œé¢å’Œå›­ 4.5 å°æ—¶ï¼‰
- âœ… ä¼˜åŒ–äº¤é€šè·¯çº¿ï¼ˆå‡å°‘å¾€è¿”ï¼Œä¸»è¦ä½¿ç”¨åœ°é“ï¼‰
- âœ… ç¬¬ 3 å¤©å®‰æ’è¾ƒè½»æ¾ï¼Œé¿å…ç–²åŠ³

---

### Step 5: æœåŠ¡å±‚è½¬æ¢å“åº”

**å¤„ç†é€»è¾‘**: `buildPlanResponse(aiResponse)`

**è½¬æ¢è¿‡ç¨‹**:
1. éå† AI è¿”å›çš„æ¯ä¸€å¤© (`AiPlannedDay`)
2. å°†æ—¥æœŸä» `LocalDate` è½¬æ¢ä¸º `String`
3. éå†æ¯å¤©çš„ç«™ç‚¹ (`AiPlannedStop`)
4. å°†æ—¶é—´å­—æ®µä» `LocalTime` è½¬æ¢ä¸º `String`
5. å°†å­—æ®µæ˜ å°„åˆ° API è§„èŒƒçš„ `PlannedStop` æ ¼å¼

**æœ€ç»ˆ API å“åº”** (`PlanItineraryResponse`):

```json
{
  "days": [
    {
      "date": "2025-10-15",
      "stops": [
        {
          "order": 1,
          "place": null,
          "arrivalLocal": "09:00",
          "departLocal": "10:00",
          "stayMinutes": 60,
          "note": "è§‚çœ‹å‡æ——ä»ªå¼ï¼ˆå¦‚éœ€è¦è¯·æå‰åˆ°è¾¾ï¼‰ï¼Œå‚è§‚å¹¿åœºå‘¨è¾¹å»ºç­‘ï¼Œæ‹ç…§ç•™å¿µ"
        },
        {
          "order": 2,
          "place": null,
          "arrivalLocal": "10:15",
          "departLocal": "14:00",
          "stayMinutes": 225,
          "note": "æ·±åº¦æ¸¸è§ˆå¤ªå’Œæ®¿ã€ä¸­å’Œæ®¿ã€ä¿å’Œæ®¿ç­‰ä¸‰å¤§æ®¿ï¼Œåå®«åŒºåŸŸå’Œçå®é¦†ï¼Œå»ºè®®æŒ‰ä¸­è½´çº¿æ¸¸è§ˆ"
        },
        {
          "order": 3,
          "place": null,
          "arrivalLocal": "14:30",
          "departLocal": "16:00",
          "stayMinutes": 90,
          "note": "ç™»é¡¶ä¸‡æ˜¥äº­ï¼Œ360åº¦ä¿¯ç°ç´«ç¦åŸå…¨æ™¯ï¼Œæ˜¯æ‹æ‘„æ•…å®«æœ€ä½³æœºä½"
        },
        {
          "order": 4,
          "place": null,
          "arrivalLocal": "16:45",
          "departLocal": "18:30",
          "stayMinutes": 105,
          "note": "æ¼«æ­¥èƒ¡åŒï¼Œæ¢è®¿æ–‡è‰ºå°åº—ã€å’–å•¡é¦†å’Œç‰¹è‰²é¤å…ï¼Œå“å°åŒ—äº¬å°åƒ"
        },
        {
          "order": 5,
          "place": null,
          "arrivalLocal": "19:00",
          "departLocal": "20:00",
          "stayMinutes": 60,
          "note": "å¤œæ¸¸ä»€åˆ¹æµ·ï¼Œæ¬£èµæ¹–ç•”å¤œæ™¯ï¼Œå¯é€‰æ‹©åœ¨æ¹–è¾¹é…’å§å°æ†©æˆ–ä¹˜èˆ¹æ¸¸è§ˆ"
        }
      ]
    },
    {
      "date": "2025-10-16",
      "stops": [
        {
          "order": 1,
          "place": null,
          "arrivalLocal": "09:00",
          "departLocal": "13:30",
          "stayMinutes": 270,
          "note": "æ¸¸è§ˆä¸‡å¯¿å±±ã€ä½›é¦™é˜ã€é•¿å»Šï¼ˆ728ç±³å½©ç”»é•¿å»Šï¼‰ã€æ˜†æ˜æ¹–ï¼Œå»ºè®®ç§Ÿèˆ¹æ¸¸æ¹–æˆ–æ²¿æ¹–æ¼«æ­¥"
        },
        {
          "order": 2,
          "place": null,
          "arrivalLocal": "14:30",
          "departLocal": "17:30",
          "stayMinutes": 180,
          "note": "å‚è§‚å¤§æ°´æ³•é—å€ç­‰è¥¿æ´‹æ¥¼æ™¯åŒºï¼Œäº†è§£åœ†æ˜å›­å†å²ï¼Œæ„Ÿå—çš‡å®¶å›­æ—çš„æ²§æ¡‘å˜è¿"
        }
      ]
    },
    {
      "date": "2025-10-17",
      "stops": [
        {
          "order": 1,
          "place": null,
          "arrivalLocal": "09:00",
          "departLocal": "12:00",
          "stayMinutes": 180,
          "note": "æ¸¸è§ˆç¥ˆå¹´æ®¿ã€å›éŸ³å£ã€åœœä¸˜ï¼Œè§‚çœ‹è€åŒ—äº¬æ™¨ç»ƒæ–‡åŒ–ï¼Œä½“éªŒå›éŸ³å£çš„å¥‡å¦™å£°å­¦æ•ˆæœ"
        }
      ]
    }
  ]
}
```

> **æ³¨æ„**: å½“å‰å®ç°ä¸­ `place` å­—æ®µä¸º `null`ï¼Œåç»­ä¼˜åŒ–å°†ä»æ•°æ®åº“æŸ¥è¯¢å®Œæ•´çš„ `PlaceDTO` å¯¹è±¡

---

### Step 6: å‰ç«¯å±•ç¤º

å‰ç«¯æ¥æ”¶åˆ°å“åº”åï¼Œå°†æŒ‰å¤©å±•ç¤ºè¡Œç¨‹ï¼š

```
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… Day 1 - 2025å¹´10æœˆ15æ—¥ (å‘¨äºŒ)
æ¢ç´¢å¤©å®‰é—¨-æ•…å®«æ ¸å¿ƒåŒºï¼Œæ„Ÿå—çš‡åŸå¨ä¸¥ä¸èƒ¡åŒé£æƒ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ•˜ 09:00 - 10:00  |  ğŸ“ å¤©å®‰é—¨å¹¿åœº  |  â±ï¸ 1å°æ—¶
â””â”€ è§‚çœ‹å‡æ——ä»ªå¼ï¼ˆå¦‚éœ€è¦è¯·æå‰åˆ°è¾¾ï¼‰ï¼Œå‚è§‚å¹¿åœºå‘¨è¾¹å»ºç­‘ï¼Œæ‹ç…§ç•™å¿µ
    ğŸš¶ æ­¥è¡Œ 15åˆ†é’Ÿ â†“

ğŸ•¥ 10:15 - 14:00  |  ğŸ“ æ•…å®«åšç‰©é™¢  |  â±ï¸ 3å°æ—¶45åˆ†é’Ÿ
â””â”€ æ·±åº¦æ¸¸è§ˆå¤ªå’Œæ®¿ã€ä¸­å’Œæ®¿ã€ä¿å’Œæ®¿ç­‰ä¸‰å¤§æ®¿ï¼Œåå®«åŒºåŸŸå’Œçå®é¦†
    ğŸš¶ æ­¥è¡Œ 30åˆ†é’Ÿ â†“

ğŸ• 14:30 - 16:00  |  ğŸ“ æ™¯å±±å…¬å›­  |  â±ï¸ 1å°æ—¶30åˆ†é’Ÿ
â””â”€ ç™»é¡¶ä¸‡æ˜¥äº­ï¼Œ360åº¦ä¿¯ç°ç´«ç¦åŸå…¨æ™¯ï¼Œæ˜¯æ‹æ‘„æ•…å®«æœ€ä½³æœºä½
    ğŸš‡ åœ°é“8å·çº¿ 45åˆ†é’Ÿ â†“

ğŸ•“ 16:45 - 18:30  |  ğŸ“ å—é”£é¼“å··  |  â±ï¸ 1å°æ—¶45åˆ†é’Ÿ
â””â”€ æ¼«æ­¥èƒ¡åŒï¼Œæ¢è®¿æ–‡è‰ºå°åº—ã€å’–å•¡é¦†å’Œç‰¹è‰²é¤å…ï¼Œå“å°åŒ—äº¬å°åƒ
    ğŸš¶ æ­¥è¡Œ 30åˆ†é’Ÿ â†“

ğŸ•– 19:00 - 20:00  |  ğŸ“ ä»€åˆ¹æµ·  |  â±ï¸ 1å°æ—¶
â””â”€ å¤œæ¸¸ä»€åˆ¹æµ·ï¼Œæ¬£èµæ¹–ç•”å¤œæ™¯ï¼Œå¯é€‰æ‹©åœ¨æ¹–è¾¹é…’å§å°æ†©æˆ–ä¹˜èˆ¹æ¸¸è§ˆ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… Day 2 - 2025å¹´10æœˆ16æ—¥ (å‘¨ä¸‰)
è¥¿éƒŠçš‡å®¶å›­æ—å·¡ç¤¼ï¼Œé¢†ç•¥çš‡å®¶é€ å›­è‰ºæœ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ•˜ 09:00 - 13:30  |  ğŸ“ é¢å’Œå›­  |  â±ï¸ 4å°æ—¶30åˆ†é’Ÿ
â””â”€ æ¸¸è§ˆä¸‡å¯¿å±±ã€ä½›é¦™é˜ã€é•¿å»Šï¼ˆ728ç±³å½©ç”»é•¿å»Šï¼‰ã€æ˜†æ˜æ¹–
    ğŸšŒ å…¬äº¤ 60åˆ†é’Ÿ â†“

ğŸ• 14:30 - 17:30  |  ğŸ“ åœ†æ˜å›­  |  â±ï¸ 3å°æ—¶
â””â”€ å‚è§‚å¤§æ°´æ³•é—å€ç­‰è¥¿æ´‹æ¥¼æ™¯åŒºï¼Œäº†è§£åœ†æ˜å›­å†å²

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… Day 3 - 2025å¹´10æœˆ17æ—¥ (å‘¨å››)
å¤©å›ç¥ˆç¦ï¼Œåœ†æ»¡ç»“æŸåŒ—äº¬æ–‡åŒ–ä¹‹æ—…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ•˜ 09:00 - 12:00  |  ğŸ“ å¤©å›å…¬å›­  |  â±ï¸ 3å°æ—¶
â””â”€ æ¸¸è§ˆç¥ˆå¹´æ®¿ã€å›éŸ³å£ã€åœœä¸˜ï¼Œè§‚çœ‹è€åŒ—äº¬æ™¨ç»ƒæ–‡åŒ–
```

---

### æµç¨‹æ€»ç»“

#### æ•°æ®è½¬æ¢é“¾è·¯

```
æ•°æ®åº“å®ä½“ (Entity)
    â†“ æŸ¥è¯¢
ItineraryEntity + List<ItineraryPlaceEntity>
    â†“ buildAiRequest()
AiPlanRequest (AI è¯·æ±‚æ ¼å¼)
    â†“ HTTP POST
AI æ¨¡å‹å¤„ç†
    â†“ HTTP Response
AiPlanResponse (AI å“åº”æ ¼å¼)
    â†“ buildPlanResponse()
PlanItineraryResponse (API å“åº”æ ¼å¼)
    â†“ JSON
å‰ç«¯å±•ç¤º
```

#### å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆæœ¬æ¬¡ç¤ºä¾‹ï¼‰

| æŒ‡æ ‡ | æ•°å€¼ |
|-----|------|
| è¡Œç¨‹å¤©æ•° | 3 å¤© |
| åœ°ç‚¹æ€»æ•° | 8 ä¸ª |
| å¿…å»åœ°ç‚¹ | 3 ä¸ª |
| æ€»æ¸¸è§ˆæ—¶é—´ | çº¦ 23.5 å°æ—¶ |
| Day 1 ç«™ç‚¹æ•° | 5 ä¸ª |
| Day 2 ç«™ç‚¹æ•° | 2 ä¸ª |
| Day 3 ç«™ç‚¹æ•° | 1 ä¸ª |
| å¹³å‡æ¯å¤©æ¸¸è§ˆæ—¶é—´ | çº¦ 7.8 å°æ—¶ |
| AI å¤„ç†æ—¶é—´ | < 2 ç§’ï¼ˆé¢„ä¼°ï¼‰|
| æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•° | 2 æ¬¡ |
| HTTP è¯·æ±‚æ¬¡æ•° | 1 æ¬¡ï¼ˆAI è°ƒç”¨ï¼‰|

#### ç”¨æˆ·ä»·å€¼

1. **èŠ‚çœè§„åˆ’æ—¶é—´**: ç”¨æˆ·æ— éœ€æ‰‹åŠ¨å®‰æ’è·¯çº¿å’Œæ—¶é—´ï¼ŒAI è‡ªåŠ¨ç”Ÿæˆä¼˜åŒ–æ–¹æ¡ˆ
2. **ä¸“ä¸šè·¯çº¿å»ºè®®**: åŸºäºåœ°ç†ä½ç½®ã€å¼€æ”¾æ—¶é—´ç­‰å› ç´ çš„æ™ºèƒ½ä¼˜åŒ–
3. **çµæ´»å¯è°ƒæ•´**: ç”¨æˆ·å¯ä»¥åŸºäºç”Ÿæˆçš„è®¡åˆ’è¿›è¡Œå¾®è°ƒ
4. **è¯¦ç»†æ´»åŠ¨æŒ‡å¯¼**: æ¯ä¸ªç«™ç‚¹éƒ½æœ‰å…·ä½“çš„æ´»åŠ¨å»ºè®®
5. **äº¤é€šæŒ‡å¼•**: æ˜ç¡®çš„äº¤é€šæ–¹å¼å’Œé¢„ä¼°æ—¶é•¿

---

## åç»­ä¼˜åŒ–å»ºè®®

1. **å®Œå–„ PlaceDTO å¡«å……**: åœ¨è½¬æ¢ `PlannedStop` æ—¶ï¼Œä»æ•°æ®åº“æŸ¥è¯¢å®Œæ•´çš„åœ°ç‚¹ä¿¡æ¯
2. **ç¼“å­˜ä¼˜åŒ–**: å¯¹é¢‘ç¹è®¿é—®çš„è¡Œç¨‹å’Œåœ°ç‚¹ä¿¡æ¯æ·»åŠ ç¼“å­˜
3. **å¼‚æ­¥å¤„ç†**: å¯¹äºå¤æ‚è¡Œç¨‹ï¼Œè€ƒè™‘ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆè®¡åˆ’
4. **é‡è¯•æœºåˆ¶**: ä¸º AI æœåŠ¡è°ƒç”¨æ·»åŠ é‡è¯•å’Œé™çº§ç­–ç•¥
5. **æ—¥å¿—å¢å¼º**: æ·»åŠ è¯¦ç»†çš„ä¸šåŠ¡æ—¥å¿—ï¼Œä¾¿äºè¿½è¸ªå’Œè°ƒè¯•
6. **æ€§èƒ½ç›‘æ§**: è®°å½• AI è°ƒç”¨çš„å“åº”æ—¶é—´å’ŒæˆåŠŸç‡
7. **ç”¨æˆ·åé¦ˆå¾ªç¯**: æ”¶é›†ç”¨æˆ·å¯¹è®¡åˆ’çš„è¯„ä»·ï¼Œä¼˜åŒ– AI æ¨¡å‹

---

